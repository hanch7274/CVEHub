<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket 동작 가시화</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .visualization-area {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            min-height: 400px;
        }
        .client, .server {
            width: 45%;
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .client {
            background-color: #e6f7ff;
        }
        .server {
            background-color: #f6ffed;
        }
        .connection-line {
            position: absolute;
            height: 2px;
            background-color: #1890ff;
            top: 50%;
            left: 0;
            width: 0;
            transition: width 1s ease-in-out;
            z-index: 10;
        }
        .message {
            position: absolute;
            width: 50px;
            height: 30px;
            background-color: #91d5ff;
            border-radius: 5px;
            text-align: center;
            line-height: 30px;
            color: white;
            font-weight: bold;
            transition: left 1s ease-in-out;
            z-index: 20;
            opacity: 0;
        }
        .client-to-server {
            left: 25%;
        }
        .server-to-client {
            left: 75%;
        }
        .component {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.7);
        }
        .component h3 {
            margin-top: 0;
            color: #1890ff;
        }
        .controls {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #40a9ff;
        }
        button:disabled {
            background-color: #bfbfbf;
            cursor: not-allowed;
        }
        .log-area {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .log {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }
        .log-info {
            background-color: #e6f7ff;
        }
        .log-warn {
            background-color: #fffbe6;
        }
        .log-error {
            background-color: #fff2f0;
        }
        .status-connected {
            color: #52c41a;
            font-weight: bold;
        }
        .status-connecting {
            color: #faad14;
            font-weight: bold;
        }
        .status-disconnected {
            color: #ff4d4f;
            font-weight: bold;
        }
        .status-active {
            color: #52c41a;
            font-weight: bold;
        }
        .status-idle {
            color: #bfbfbf;
            font-weight: bold;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 0;
        }
        .stage-indicator {
            margin-top: 20px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            padding: 15px;
            background-color: white;
        }
        .stages {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .stage {
            padding: 8px 15px;
            background-color: #f5f5f5;
            border-radius: 30px;
            font-size: 14px;
            position: relative;
        }
        .stage.active {
            background-color: #e6f7ff;
            color: #1890ff;
            font-weight: bold;
        }
        .stage.completed {
            background-color: #f6ffed;
            color: #52c41a;
        }
        .stage.error {
            background-color: #fff2f0;
            color: #ff4d4f;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CVEHub 웹소켓 동작 가시화</h1>
            <p>CVEHub 애플리케이션의 웹소켓 통신 과정을 시각적으로 보여줍니다.</p>
        </div>

        <div class="controls">
            <button id="connect-btn">연결</button>
            <button id="send-message-btn" disabled>메시지 전송</button>
            <button id="subscribe-btn" disabled>이벤트 구독</button>
            <button id="disconnect-btn" disabled>연결 해제</button>
            <button id="reset-btn">초기화</button>
        </div>

        <div class="visualization-area">
            <div class="client">
                <h2>클라이언트 (React)</h2>
                <div class="component">
                    <h3>Socket.IO 서비스</h3>
                    <div class="status" id="client-status">연결 상태: <span class="status-disconnected">연결 안됨</span></div>
                </div>
                <div class="component">
                    <h3>이벤트 리스너</h3>
                    <div id="event-listeners">구독중인 이벤트 없음</div>
                </div>
                <div class="component">
                    <h3>CrawlerUpdateButton 컴포넌트</h3>
                    <div>상태: <span id="crawlerComponentStatus">초기화됨</span></div>
                    <div>진행 단계: <span id="crawlerStage">대기 중</span></div>
                    <div class="stage-indicator">
                        <div id="stageProgress">진행률: 0%</div>
                        <div class="stages">
                            <div class="stage" id="stage-init">준비</div>
                            <div class="stage" id="stage-fetching">수집</div>
                            <div class="stage" id="stage-parsing">분석</div>
                            <div class="stage" id="stage-saving">저장</div>
                            <div class="stage" id="stage-complete">완료</div>
                        </div>
                    </div>
                </div>
                <div class="actions">
                    <h3>메시지 처리</h3>
                    <div id="received-message" class="message-content" style="display: none;"></div>
                </div>
            </div>

            <div id="connection-visualization" style="position: relative; width: 10%; display: flex; justify-content: center; align-items: center;">
                <div id="connection-line" style="position: absolute; width: 100%; height: 2px; background-color: #ccc; top: 30%;"></div>
                <div id="message-animation" style="position: absolute; width: 30px; height: 30px; background-color: #1890ff; border-radius: 50%; top: 29%; left: 0; display: none;"></div>
            </div>

            <div class="server">
                <h2>서버 (FastAPI)</h2>
                <div class="component">
                    <h3>WebSocket 매니저</h3>
                    <div class="status" id="server-status">상태: <span class="status-idle">대기 중</span></div>
                </div>
                <div class="component">
                    <h3>이벤트 발행</h3>
                    <div id="server-events">발행된 이벤트 없음</div>
                </div>
                <div class="actions">
                    <h3>활성 연결</h3>
                    <div id="active-connections">0</div>
                </div>
            </div>
        </div>

        <h2>로그</h2>
        <div class="log-area" id="log-container"></div>
    </div>

    <script>
        // 상태 관리
        const state = {
            connected: false,
            subscribed: false,
            messages: []
        };

        // 요소 참조
        const connectBtn = document.getElementById('connect-btn');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const subscribeBtn = document.getElementById('subscribe-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const resetBtn = document.getElementById('reset-btn');
        const clientStatus = document.getElementById('client-status');
        const serverStatus = document.getElementById('server-status');
        const eventListeners = document.getElementById('event-listeners');
        const serverEvents = document.getElementById('server-events');
        const activeConnections = document.getElementById('active-connections');
        const logContainer = document.getElementById('log-container');
        const receivedMessage = document.getElementById('received-message');
        const connectionLine = document.getElementById('connection-line');
        const messageAnimation = document.getElementById('message-animation');

        // 로그 추가 함수
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry event-${type}`;
            logEntry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 연결 버튼 이벤트
        connectBtn.addEventListener('click', () => {
            addLog('웹소켓 연결 시도 중...', 'info');
            clientStatus.innerHTML = '연결 상태: <span class="status-connecting">연결 중...</span>';
            serverStatus.innerHTML = '상태: <span class="status-connecting">연결 요청 수신...</span>';
            
            // 연결 애니메이션
            connectionLine.style.backgroundColor = '#faad14';
            
            // 3초 후 연결 성공 시뮬레이션
            setTimeout(() => {
                state.connected = true;
                clientStatus.innerHTML = '연결 상태: <span class="status-connected">연결됨</span>';
                serverStatus.innerHTML = '상태: <span class="status-connected">활성화됨</span>';
                connectionLine.style.backgroundColor = '#52c41a';
                
                sendMessageBtn.disabled = false;
                subscribeBtn.disabled = false;
                disconnectBtn.disabled = false;
                connectBtn.disabled = true;
                
                activeConnections.innerText = '1';
                
                addLog('웹소켓 연결 성공!', 'info');
            }, 2000);
        });

        // 메시지 전송 버튼 이벤트
        sendMessageBtn.addEventListener('click', () => {
            if (!state.connected) return;
            
            const message = {
                event: 'crawler_update',
                data: {
                    crawlerId: 'nuclei_crawler',
                    status: 'in_progress',
                    progress: 45,
                    timestamp: new Date().toISOString()
                }
            };
            
            addLog(`클라이언트에서 메시지 전송: ${JSON.stringify(message)}`, 'info');
            
            // 메시지 전송 애니메이션
            messageAnimation.style.display = 'block';
            messageAnimation.style.left = '0';
            
            // 서버로 이동 애니메이션
            setTimeout(() => {
                messageAnimation.style.left = '100%';
                
                // 서버에서 메시지 수신
                setTimeout(() => {
                    messageAnimation.style.display = 'none';
                    serverEvents.innerHTML = `마지막 이벤트: crawler_update (${new Date().toLocaleTimeString()})`;
                    addLog('서버에서 메시지 수신 및 처리', 'info');
                    
                    // 서버에서 응답 (선택적)
                    if (state.subscribed) {
                        setTimeout(() => {
                            respondFromServer();
                        }, 1000);
                    }
                }, 1000);
            }, 1000);
        });

        // 서버에서 응답 함수
        function respondFromServer() {
            const responseMessage = {
                event: 'crawler_update',
                data: {
                    crawlerId: 'nuclei_crawler',
                    stage: 'parsing_data',
                    progress: 60,
                    timestamp: new Date().toISOString(),
                    message: '데이터 분석 중...'
                }
            };
            
            addLog(`서버에서 응답 전송: ${JSON.stringify(responseMessage)}`, 'info');
            
            // 응답 애니메이션
            messageAnimation.style.display = 'block';
            messageAnimation.style.left = '100%';
            messageAnimation.style.backgroundColor = '#52c41a';
            
            // 클라이언트로 이동 애니메이션
            setTimeout(() => {
                messageAnimation.style.left = '0';
                
                // 클라이언트에서 응답 수신
                setTimeout(() => {
                    messageAnimation.style.display = 'none';
                    messageAnimation.style.backgroundColor = '#1890ff';
                    
                    // 클라이언트에서 메시지 표시
                    receivedMessage.style.display = 'block';
                    receivedMessage.innerHTML = `<pre>${JSON.stringify(responseMessage, null, 2)}</pre>`;
                    
                    // CrawlerUpdateButton 컴포넌트 업데이트
                    const stageElement = document.getElementById('crawlerStage');
                    const progressElement = document.getElementById('stageProgress');
                    const componentStatusElement = document.getElementById('crawlerComponentStatus');
                    
                    // 모든 단계 초기화
                    document.querySelectorAll('.stage').forEach(el => {
                        el.classList.remove('active', 'completed', 'error');
                    });
                    
                    // 현재 단계 설정
                    let currentStageId;
                    if (responseMessage.data.stage.includes('preparing')) {
                        currentStageId = 'stage-init';
                        stageElement.innerText = '준비 중';
                    } else if (responseMessage.data.stage.includes('fetching')) {
                        currentStageId = 'stage-fetching';
                        stageElement.innerText = '데이터 수집 중';
                    } else if (responseMessage.data.stage.includes('parsing')) {
                        currentStageId = 'stage-parsing';
                        stageElement.innerText = '데이터 분석 중';
                    } else if (responseMessage.data.stage.includes('saving')) {
                        currentStageId = 'stage-saving';
                        stageElement.innerText = '데이터 저장 중';
                    } else if (responseMessage.data.stage.includes('complete')) {
                        currentStageId = 'stage-complete';
                        stageElement.innerText = '완료됨';
                    } else if (responseMessage.data.stage.includes('error')) {
                        // 에러 상태 처리
                        currentStageId = null;
                        stageElement.innerText = '오류 발생';
                        document.getElementById('stage-init').classList.add('error');
                        componentStatusElement.innerText = '오류: ' + responseMessage.data.message;
                    }
                    
                    if (currentStageId) {
                        // 현재 단계 활성화
                        document.getElementById(currentStageId).classList.add('active');
                        
                        // 이전 단계는 완료 표시
                        let foundCurrent = false;
                        document.querySelectorAll('.stage').forEach(el => {
                            if (el.id === currentStageId) {
                                foundCurrent = true;
                            } else if (!foundCurrent) {
                                el.classList.add('completed');
                            }
                        });
                        
                        componentStatusElement.innerText = '실행 중: processWebSocketData 처리됨';
                    }
                    
                    // 진행률 업데이트
                    progressElement.innerText = `진행률: ${responseMessage.data.progress}%`;
                    
                    addLog(`CrawlerUpdateButton이 웹소켓 데이터를 처리함: stage=${responseMessage.data.stage}, progress=${responseMessage.data.progress}%`, 'info');
                }, 1000);
            }, 1000);
        }

        // 이벤트 구독 버튼 이벤트
        subscribeBtn.addEventListener('click', () => {
            if (!state.connected) return;
            
            state.subscribed = !state.subscribed;
            
            if (state.subscribed) {
                eventListeners.innerHTML = 'crawler_update 이벤트 구독중';
                addLog('crawler_update 이벤트 구독 시작', 'info');
                subscribeBtn.innerText = '구독 해제';
            } else {
                eventListeners.innerHTML = '구독중인 이벤트 없음';
                addLog('crawler_update 이벤트 구독 해제', 'info');
                subscribeBtn.innerText = '이벤트 구독';
            }
        });

        // 연결 해제 버튼 이벤트
        disconnectBtn.addEventListener('click', () => {
            addLog('웹소켓 연결 종료 중...', 'warn');
            
            setTimeout(() => {
                state.connected = false;
                state.subscribed = false;
                
                clientStatus.innerHTML = '연결 상태: <span class="status-disconnected">연결 안됨</span>';
                serverStatus.innerHTML = '상태: <span class="status-idle">대기 중</span>';
                connectionLine.style.backgroundColor = '#ccc';
                
                sendMessageBtn.disabled = true;
                subscribeBtn.disabled = true;
                disconnectBtn.disabled = true;
                connectBtn.disabled = false;
                
                eventListeners.innerHTML = '구독중인 이벤트 없음';
                serverEvents.innerHTML = '발행된 이벤트 없음';
                activeConnections.innerText = '0';
                receivedMessage.style.display = 'none';
                
                addLog('웹소켓 연결 종료됨', 'warn');
            }, 1000);
        });

        // 초기화 버튼 이벤트
        resetBtn.addEventListener('click', () => {
            state.connected = false;
            state.subscribed = false;
            state.messages = [];
            
            clientStatus.innerHTML = '연결 상태: <span class="status-disconnected">연결 안됨</span>';
            serverStatus.innerHTML = '상태: <span class="status-idle">대기 중</span>';
            connectionLine.style.backgroundColor = '#ccc';
            
            sendMessageBtn.disabled = true;
            subscribeBtn.disabled = true;
            disconnectBtn.disabled = true;
            connectBtn.disabled = false;
            
            eventListeners.innerHTML = '구독중인 이벤트 없음';
            serverEvents.innerHTML = '발행된 이벤트 없음';
            activeConnections.innerText = '0';
            receivedMessage.style.display = 'none';
            
            // 로그 초기화
            logContainer.innerHTML = '';
            addLog('시스템 초기화됨', 'info');
        });

        // 초기 로그
        addLog('시스템 초기화됨', 'info');
        addLog('CVEHub 웹소켓 가시화 도구가 준비되었습니다.', 'info');
        addLog('왼쪽은 클라이언트(React), 오른쪽은 서버(FastAPI)를 나타냅니다.', 'info');
        addLog('위쪽 버튼을 사용하여 웹소켓 통신 과정을 시뮬레이션할 수 있습니다.', 'info');
    </script>
</body>
</html>
